<html><head><title>Module Lwt_switch </title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="text/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="Lwt_switch lwt"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Lwt</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p class="mainmenu-current"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../deriving/" class="ocsimore_phrasing_link">deriving</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../1.0.0/wiki/Lwt_switch">1.0.0</option><option value=".././../1.1.0/wiki/Lwt_switch">1.1.0</option><option value=".././../2.0.0/wiki/Lwt_switch">2.0.0</option><option value=".././../2.1.0/wiki/Lwt_switch">2.1.0</option><option value=".././../2.1.1/wiki/Lwt_switch">2.1.1</option><option value=".././../2.2.0/wiki/Lwt_switch">2.2.0</option><option value=".././../2.2.1/wiki/Lwt_switch">2.2.1</option><option value=".././../2.3.0/wiki/Lwt_switch">2.3.0</option><option value=".././../2.3.1/wiki/Lwt_switch">2.3.1</option><option value=".././../2.3.2/wiki/Lwt_switch">2.3.2</option><option value=".././../2.4.0/wiki/Lwt_switch">2.4.0</option><option value=".././../2.4.1/wiki/Lwt_switch">2.4.1</option><option value=".././../2.4.2/wiki/Lwt_switch">2.4.2</option><option value=".././../2.4.3/wiki/Lwt_switch">2.4.3</option><option value=".././../2.4.7/wiki/Lwt_switch">2.4.7</option><option value=".././../2.4.8/wiki/Lwt_switch">2.4.8</option><option value=".././../2.5.0/wiki/Lwt_switch">2.5.0</option><option value=".././../2.5.1/wiki/Lwt_switch">2.5.1</option><option value=".././../2.5.2/wiki/Lwt_switch">2.5.2</option><option value=".././../2.6.0/wiki/Lwt_switch">2.6.0</option><option value=".././../2.7.0/wiki/Lwt_switch">2.7.0</option><option value=".././../2.7.1/wiki/Lwt_switch">2.7.1</option><option value=".././../3.0.0/wiki/Lwt_switch">3.0.0</option><option value=".././../3.1.0/wiki/Lwt_switch">3.1.0</option><option value=".././../3.2.1/wiki/Lwt_switch">3.2.1</option><option value=".././../3.3.0/wiki/Lwt_switch">3.3.0</option><option value=".././../4.0.0/wiki/Lwt_switch">4.0.0</option><option value=".././../4.0.1/wiki/Lwt_switch">4.0.1</option><option value=".././../4.1.0/wiki/Lwt_switch">4.1.0</option><option value=".././../4.2.0/wiki/Lwt_switch">4.2.0</option><option value=".././../4.2.1/wiki/Lwt_switch">4.2.1</option><option value=".././../4.3.0/wiki/Lwt_switch">4.3.0</option><option value=".././../4.3.1/wiki/Lwt_switch">4.3.1</option><option value=".././../4.4.0/wiki/Lwt_switch">4.4.0</option><option value=".././../4.5.0/wiki/Lwt_switch">4.5.0</option><option value=".././../5.0.0/wiki/Lwt_switch">5.0.0</option><option value=".././../5.0.1/wiki/Lwt_switch">5.0.1</option><option value=".././../5.1.0/wiki/Lwt_switch">5.1.0</option><option value=".././../5.1.1/wiki/Lwt_switch">5.1.1</option><option value=".././../5.1.2/wiki/Lwt_switch">5.1.2</option><option value=".././../5.2.0/wiki/Lwt_switch">5.2.0</option><option value=".././../5.3.0/wiki/Lwt_switch">5.3.0</option><option value=".././../5.4.0/wiki/Lwt_switch">5.4.0</option><option value=".././../5.4.1/wiki/Lwt_switch">5.4.1</option><option value=".././../5.4.2/wiki/Lwt_switch" selected="selected">5.4.2</option><option value=".././../5.5.0/wiki/Lwt_switch">5.5.0</option><option value=".././../dev/wiki/Lwt_switch">dev</option></select><nav class="how-doctree"></nav></nav><article class="rightcol"><h1>Module <span><a href=".././api/Lwt_switch">Lwt_switch</a></span> </h1><pre class="ocsforge_color odocwiki_code"><span class="ocsforge_color_keyword">module</span> <span class="ocsforge_color_uid"><span class="ocsforge_color_uid">Lwt_switch</span></span> <span class="ocsforge_color_delimiter">:</span> <span class="ocsforge_color_keyword">sig</span><span><a href=".././api/Lwt_switch">..</a></span><span class="ocsforge_color_keyword">end</span></pre><p>Lwt switches
</p><hr/><p>Switch has two goals:
</p><ul><li> being able to free multiple resources at the same time,
</li><li> offer a better alternative than always returning an id to free
some resource.
</li></ul><p>For example, consider the following interface:
</p><p>
</p><pre class=""><code class="language-ocaml translatable">type id

      val free : id -&gt; unit Lwt.t

      val f : unit -&gt; id Lwt.t
      val g : unit -&gt; id Lwt.t
      val h : unit -&gt; id Lwt.t</code></pre><p>Now you want to call <span class="odocwiki_inlinecode">f</span>, <span class="odocwiki_inlinecode">g</span> and <span class="odocwiki_inlinecode">h</span> in parallel. You can
simply do:
</p><p>
</p><pre class=""><code class="language-ocaml translatable">lwt idf = f () and idg = g () and idh = h () in
      ...</code></pre><p>However, one may want to handle possible failures of <span class="odocwiki_inlinecode">f ()</span>, <span class="odocwiki_inlinecode">g ()</span>
and <span class="odocwiki_inlinecode">h ()</span>, and disable all allocated resources if one of
these three threads fails. This may be hard since you have to
remember which one failed and which one returned correctly.
</p><p>Now if we change the interface a little bit:
</p><p>
</p><pre class=""><code class="language-ocaml translatable">val f : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val g : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val h : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t</code></pre><p>the code becomes:
</p><p>
</p><pre class=""><code class="language-ocaml translatable">Lwt_switch.with_switch (fun switch -&gt;
        lwt idf = f ~switch ()
        and idg = g ~switch ()
        and idh = h ~switch () in
        ...
      )</code></pre><pre class="ocsforge_color odocwiki_code" id="TYPEt"><span class="ocsforge_color_keyword">type</span> <span class="odocwiki_name">t</span></pre><div class="odocwiki_info"><p>Type of switches.</p></div><pre class="ocsforge_color odocwiki_code" id="VALcreate"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">create</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type">unit <span class="ocsforge_color_delimiter">-&gt;</span> <span><a href=".././api/Lwt_switch#TYPEt">t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">create ()</span> creates a new switch.</p></div><pre class="ocsforge_color odocwiki_code" id="VALwith_switch"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">with_switch</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span class="ocsforge_color_delimiter">(</span><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> <span class="ocsforge_color_delimiter">-&gt;</span> 'a <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span><span class="ocsforge_color_delimiter">)</span> <span class="ocsforge_color_delimiter">-&gt;</span> 'a <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">with_switch fn</span> is <span class="odocwiki_inlinecode">fn switch</span>, where <span class="odocwiki_inlinecode">switch</span> is a fresh switch
that is turned off when the callback thread finishes (whether it
succeeds or fails).
<strong>Since</strong> 2.6.0<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALis_on"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">is_on</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> <span class="ocsforge_color_delimiter">-&gt;</span> bool</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">is_on switch</span> returns <span class="odocwiki_inlinecode">true</span> if the switch is currently on, and
<span class="odocwiki_inlinecode">false</span> otherwise.</p></div><pre class="ocsforge_color odocwiki_code" id="VALturn_off"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">turn_off</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">turn_off switch</span> turns off the switch. It calls all registered
hooks, waits for all of them to terminate, then returns. If
one of the hooks failed, it will fail with the exception raised
by the hook. If the switch is already off, it does nothing.</p></div><pre class="ocsforge_color odocwiki_code" id="EXCEPTIONOff"><span class="ocsforge_color_keyword">exception</span> <span class="odocwiki_name">Off</span></pre><div class="odocwiki_info"><p>Exception raised when trying to add a hook to a switch that is
already off.</p></div><pre class="ocsforge_color odocwiki_code" id="VALcheck"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">check</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> unit</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">check switch</span> does nothing if <span class="odocwiki_inlinecode">switch</span> is <span class="odocwiki_inlinecode">None</span> or contains an
switch that is currently on, and raises <span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> otherwise.</p></div><pre class="ocsforge_color odocwiki_code" id="VALadd_hook"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">add_hook</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> <span class="ocsforge_color_delimiter">(</span>unit <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span><span class="ocsforge_color_delimiter">)</span> <span class="ocsforge_color_delimiter">-&gt;</span> unit</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">add_hook switch f</span> registers <span class="odocwiki_inlinecode">f</span> so it will be called when
<span><a href=".././api/Lwt_switch#VALturn_off">Lwt_switch.turn_off</a></span> is invoked. It does nothing if <span class="odocwiki_inlinecode">switch</span> is
<span class="odocwiki_inlinecode">None</span>. If <span class="odocwiki_inlinecode">switch</span> contains an switch that is already off then
<span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> is raised.</p></div><pre class="ocsforge_color odocwiki_code" id="VALadd_hook_or_exec"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">add_hook_or_exec</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> <span class="ocsforge_color_delimiter">(</span>unit <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span><span class="ocsforge_color_delimiter">)</span> <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">add_hook_or_exec switch f</span> is the same as <span><a href=".././api/Lwt_switch#VALadd_hook">Lwt_switch.add_hook</a></span> except
that if the switch is already off, <span class="odocwiki_inlinecode">f</span> is called immediately.</p></div></article></div></div></body></html>
