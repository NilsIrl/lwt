<html><head><title>Module Lwt_switch </title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="text/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="Lwt_switch lwt"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Lwt</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p class="mainmenu-current"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../deriving/" class="ocsimore_phrasing_link">deriving</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1>Lwt - API Reference</h1><h2>Core library</h2><h3><a href=".././api/Lwt" class="ocsimore_phrasing_link">Lwt</a></h3><h3><a href=".././api/Lwt_condition" class="ocsimore_phrasing_link">Lwt_condition</a></h3><h3><a href=".././api/Lwt_list" class="ocsimore_phrasing_link">Lwt_list</a></h3><h3><a href=".././api/Lwt_mutex" class="ocsimore_phrasing_link">Lwt_mutex</a></h3><h3><a href=".././api/Lwt_mvar" class="ocsimore_phrasing_link">Lwt_mvar</a></h3><h3><a href=".././api/Lwt_pool" class="ocsimore_phrasing_link">Lwt_pool</a></h3><h3><a href=".././api/Lwt_sequence" class="ocsimore_phrasing_link">Lwt_sequence</a></h3><h3><a href=".././api/Lwt_stream" class="ocsimore_phrasing_link">Lwt_stream</a></h3><h3><a href=".././api/Lwt_switch" class="ocsimore_phrasing_link">Lwt_switch</a></h3><h2>Unix bindings</h2><h3><a href=".././api/Lwt_daemon" class="ocsimore_phrasing_link">Lwt_daemon</a></h3><h3><a href=".././api/Lwt_gc" class="ocsimore_phrasing_link">Lwt_gc</a></h3><h3><a href=".././api/Lwt_io" class="ocsimore_phrasing_link">Lwt_io</a></h3><h3><a href=".././api/Lwt_log" class="ocsimore_phrasing_link">Lwt_log</a></h3><h3><a href=".././api/Lwt_main" class="ocsimore_phrasing_link">Lwt_main</a></h3><h3><a href=".././api/Lwt_process" class="ocsimore_phrasing_link">Lwt_process</a></h3><h3><a href=".././api/Lwt_throttle" class="ocsimore_phrasing_link">Lwt_throttle</a></h3><h3><a href=".././api/Lwt_timeout" class="ocsimore_phrasing_link">Lwt_timeout</a></h3><h3><a href=".././api/Lwt_unix" class="ocsimore_phrasing_link">Lwt_unix</a></h3><h3><a href=".././api/Lwt_bytes" class="ocsimore_phrasing_link">Lwt_bytes</a></h3><h2>Reactive programming helpers</h2><h3><a href=".././api/Lwt_event" class="ocsimore_phrasing_link">Lwt_event</a></h3><h3><a href=".././api/Lwt_signal" class="ocsimore_phrasing_link">Lwt_signal</a></h3><h2>Syntax extensions</h2><h3><a href=".././api/Pa_lwt" class="ocsimore_phrasing_link">Pa_lwt</a></h3><h3><a href=".././api/Pa_lwt_log" class="ocsimore_phrasing_link">Pa_lwt_log</a></h3><h2>Terminal manipulation</h2><h3><a href=".././api/Lwt_read_line" class="ocsimore_phrasing_link">Lwt_read_line</a></h3><h3><a href=".././api/Lwt_term" class="ocsimore_phrasing_link">Lwt_term</a></h3><h3><a href=".././api/Lwt_text" class="ocsimore_phrasing_link">Lwt_text</a></h3><h2>Miscellaneous</h2><h3><a href=".././api/Lwt_glib" class="ocsimore_phrasing_link">Lwt_glib</a></h3><h3><a href=".././api/Lwt_lib" class="ocsimore_phrasing_link">Lwt_lib</a></h3><h3><a href=".././api/Lwt_preemptive" class="ocsimore_phrasing_link">Lwt_preemptive</a></h3><h3><a href=".././api/Lwt_ssl" class="ocsimore_phrasing_link">Lwt_ssl</a></h3><h2>Index</h2></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../1.0.0/api/Lwt_switch">1.0.0</option><option value=".././../1.1.0/api/Lwt_switch">1.1.0</option><option value=".././../2.0.0/api/Lwt_switch">2.0.0</option><option value=".././../2.1.0/api/Lwt_switch">2.1.0</option><option value=".././../2.1.1/api/Lwt_switch">2.1.1</option><option value=".././../2.2.0/api/Lwt_switch" selected="selected">2.2.0</option><option value=".././../2.2.1/api/Lwt_switch">2.2.1</option><option value=".././../2.3.0/api/Lwt_switch">2.3.0</option><option value=".././../2.3.1/api/Lwt_switch">2.3.1</option><option value=".././../2.3.2/api/Lwt_switch">2.3.2</option><option value=".././../2.4.0/api/Lwt_switch">2.4.0</option><option value=".././../2.4.1/api/Lwt_switch">2.4.1</option><option value=".././../2.4.2/api/Lwt_switch">2.4.2</option><option value=".././../2.4.3/api/Lwt_switch">2.4.3</option><option value=".././../2.4.7/api/Lwt_switch">2.4.7</option><option value=".././../2.4.8/api/Lwt_switch">2.4.8</option><option value=".././../2.5.0/api/Lwt_switch">2.5.0</option><option value=".././../2.5.1/api/Lwt_switch">2.5.1</option><option value=".././../2.5.2/api/Lwt_switch">2.5.2</option><option value=".././../2.6.0/api/Lwt_switch">2.6.0</option><option value=".././../2.7.0/api/Lwt_switch">2.7.0</option><option value=".././../2.7.1/api/Lwt_switch">2.7.1</option><option value=".././../3.0.0/api/Lwt_switch">3.0.0</option><option value=".././../3.1.0/api/Lwt_switch">3.1.0</option><option value=".././../3.2.1/api/Lwt_switch">3.2.1</option><option value=".././../3.3.0/api/Lwt_switch">3.3.0</option><option value=".././../4.0.0/api/Lwt_switch">4.0.0</option><option value=".././../4.0.1/api/Lwt_switch">4.0.1</option><option value=".././../4.1.0/api/Lwt_switch">4.1.0</option><option value=".././../4.2.0/api/Lwt_switch">4.2.0</option><option value=".././../4.2.1/api/Lwt_switch">4.2.1</option><option value=".././../4.3.0/api/Lwt_switch">4.3.0</option><option value=".././../4.3.1/api/Lwt_switch">4.3.1</option><option value=".././../4.4.0/api/Lwt_switch">4.4.0</option><option value=".././../4.5.0/api/Lwt_switch">4.5.0</option><option value=".././../5.0.0/api/Lwt_switch">5.0.0</option><option value=".././../5.0.1/api/Lwt_switch">5.0.1</option><option value=".././../5.1.0/api/Lwt_switch">5.1.0</option><option value=".././../5.1.1/api/Lwt_switch">5.1.1</option><option value=".././../5.1.2/api/Lwt_switch">5.1.2</option><option value=".././../5.2.0/api/Lwt_switch">5.2.0</option><option value=".././../5.3.0/api/Lwt_switch">5.3.0</option><option value=".././../dev/api/Lwt_switch">dev</option></select><nav class="how-doctree"><h1>Lwt - API Reference</h1><h2>Core library</h2><h3><a href=".././api/Lwt" class="ocsimore_phrasing_link">Lwt</a></h3><h3><a href=".././api/Lwt_condition" class="ocsimore_phrasing_link">Lwt_condition</a></h3><h3><a href=".././api/Lwt_list" class="ocsimore_phrasing_link">Lwt_list</a></h3><h3><a href=".././api/Lwt_mutex" class="ocsimore_phrasing_link">Lwt_mutex</a></h3><h3><a href=".././api/Lwt_mvar" class="ocsimore_phrasing_link">Lwt_mvar</a></h3><h3><a href=".././api/Lwt_pool" class="ocsimore_phrasing_link">Lwt_pool</a></h3><h3><a href=".././api/Lwt_sequence" class="ocsimore_phrasing_link">Lwt_sequence</a></h3><h3><a href=".././api/Lwt_stream" class="ocsimore_phrasing_link">Lwt_stream</a></h3><h3><a href=".././api/Lwt_switch" class="ocsimore_phrasing_link">Lwt_switch</a></h3><h2>Unix bindings</h2><h3><a href=".././api/Lwt_daemon" class="ocsimore_phrasing_link">Lwt_daemon</a></h3><h3><a href=".././api/Lwt_gc" class="ocsimore_phrasing_link">Lwt_gc</a></h3><h3><a href=".././api/Lwt_io" class="ocsimore_phrasing_link">Lwt_io</a></h3><h3><a href=".././api/Lwt_log" class="ocsimore_phrasing_link">Lwt_log</a></h3><h3><a href=".././api/Lwt_main" class="ocsimore_phrasing_link">Lwt_main</a></h3><h3><a href=".././api/Lwt_process" class="ocsimore_phrasing_link">Lwt_process</a></h3><h3><a href=".././api/Lwt_throttle" class="ocsimore_phrasing_link">Lwt_throttle</a></h3><h3><a href=".././api/Lwt_timeout" class="ocsimore_phrasing_link">Lwt_timeout</a></h3><h3><a href=".././api/Lwt_unix" class="ocsimore_phrasing_link">Lwt_unix</a></h3><h3><a href=".././api/Lwt_bytes" class="ocsimore_phrasing_link">Lwt_bytes</a></h3><h2>Reactive programming helpers</h2><h3><a href=".././api/Lwt_event" class="ocsimore_phrasing_link">Lwt_event</a></h3><h3><a href=".././api/Lwt_signal" class="ocsimore_phrasing_link">Lwt_signal</a></h3><h2>Syntax extensions</h2><h3><a href=".././api/Pa_lwt" class="ocsimore_phrasing_link">Pa_lwt</a></h3><h3><a href=".././api/Pa_lwt_log" class="ocsimore_phrasing_link">Pa_lwt_log</a></h3><h2>Terminal manipulation</h2><h3><a href=".././api/Lwt_read_line" class="ocsimore_phrasing_link">Lwt_read_line</a></h3><h3><a href=".././api/Lwt_term" class="ocsimore_phrasing_link">Lwt_term</a></h3><h3><a href=".././api/Lwt_text" class="ocsimore_phrasing_link">Lwt_text</a></h3><h2>Miscellaneous</h2><h3><a href=".././api/Lwt_glib" class="ocsimore_phrasing_link">Lwt_glib</a></h3><h3><a href=".././api/Lwt_lib" class="ocsimore_phrasing_link">Lwt_lib</a></h3><h3><a href=".././api/Lwt_preemptive" class="ocsimore_phrasing_link">Lwt_preemptive</a></h3><h3><a href=".././api/Lwt_ssl" class="ocsimore_phrasing_link">Lwt_ssl</a></h3><h2>Index</h2></nav></nav><article class="rightcol"><h1>Module <span><a href=".././api/Lwt_switch">Lwt_switch</a></span> </h1><div class="code"><p><span class="keyword">module</span> Lwt_switch: <span class="code">sig</span><span><a href=".././api/Lwt_switch">..</a></span><span class="code">end</span></p></div><p>Lwt switches<br/>
</p><hr/><p><br/>
Switch have two goals:<br/>
</p><ul><li> being able to free multiple resources at the same time,
</li><li> offer a better alternative than always returning an id to free
some resource.
</li></ul><p>For example, considers the following interface:<br/>
</p><p>
</p><pre>      type id

      val free : id -&gt; unit Lwt.t

      val f : unit -&gt; id Lwt.t
      val g : unit -&gt; id Lwt.t
      val h : unit -&gt; id Lwt.t
    
</pre><p><br/>
</p><p>Now you want to calls <span class="code">f</span>, <span class="code">g</span> and <span class="code">h</span> in parallel. You can
simply do:<br/>
</p><p>
</p><pre>      lwt idf = f () and idg = g () and idh = h () in
      ...
    
</pre><p><br/>
</p><p>However, one may wants to handle possible failures of <span class="code">f ()</span>, <span class="code">g
()</span> and <span class="code">h ()</span>, and disable all allocated resources if one of
these three threads fails. This may be hard since you have to
remember which one failed and which one returned correctly.<br/>
</p><p>Now we change a little bit the interface:<br/>
</p><p>
</p><pre>      val f : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val g : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val h : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
    
</pre><p><br/>
</p><p>and the code becomes:<br/>
</p><p>
</p><pre>      let switch = Lwt_switch.create () in
      try_lwt
        lwt idf = f ~switch () and idg = g ~switch () and idh = h ~switch () in
        ...
      with exn -&gt;
        lwt () = Lwt_switch.turn_off switch in
        raise_lwt exn
    
</pre><p><br/>
</p><div class="code" id="TYPEt"><p><span class="keyword">type</span> t</p></div><div class="info"><p>Type of switches.<br/></p></div><div class="code" id="VALcreate"><p><span class="keyword">val</span> create : <span class="code type">unit -&gt; <span><a href=".././api/Lwt_switch#TYPEt">t</a></span></span></p></div><div class="info"><p><span class="code">create ()</span> creates a new switch.<br/></p></div><div class="code" id="VALis_on"><p><span class="keyword">val</span> is_on : <span class="code type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> -&gt; bool</span></p></div><div class="info"><p><span class="code">is_on switch</span> returns <span class="code">true</span> if the switch is currently on, and
<span class="code">false</span> otherwise.<br/></p></div><div class="code" id="VALturn_off"><p><span class="keyword">val</span> turn_off : <span class="code type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> -&gt; unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></p></div><div class="info"><p><span class="code">turn_off switch</span> turns off the switch. It calls all registered
hooks, waits for all of them to terminates, and the returns. If
one of the hook failed, then it will fail with one of the
exception raised by hooks. If the switch is already off, then it
does nothing.<br/></p></div><div class="code" id="EXCEPTIONOff"><p><span class="keyword">exception</span> Off</p></div><div class="info"><p>Exception raised when trying to add a hook to a switch that is
already off.<br/></p></div><div class="code" id="VALcheck"><p><span class="keyword">val</span> check : <span class="code type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option -&gt; unit</span></p></div><div class="info"><p><span class="code">check switch</span> does nothing if <span class="code">switch</span> is <span class="code">None</span> or contains an
switch that is currently on, and raise <span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> otherwise.<br/></p></div><div class="code" id="VALadd_hook"><p><span class="keyword">val</span> add_hook : <span class="code type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option -&gt; (unit -&gt; unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span>) -&gt; unit</span></p></div><div class="info"><p><span class="code">add_hook switch f</span> registers <span class="code">f</span> so it will be called when
<span><a href=".././api/Lwt_switch#VALturn_off">Lwt_switch.turn_off</a></span> is invoked. It does nothing if <span class="code">switch</span> is
<span class="code">None</span>. If <span class="code">switch</span> contains an switch that is already off then
<span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> is raised.<br/></p></div><div class="code" id="VALadd_hook_or_exec"><p><span class="keyword">val</span> add_hook_or_exec : <span class="code type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option -&gt; (unit -&gt; unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span>) -&gt; unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></p></div><div class="info"><p><span class="code">add_hook_or_exec switch f</span> is the same as <span><a href=".././api/Lwt_switch#VALadd_hook">Lwt_switch.add_hook</a></span> except
that if the switch is already off, then <span class="code">f</span> is called
immediatly.<br/></p></div></article></div></div></body></html>
